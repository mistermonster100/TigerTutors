<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="script.js" defer></script>
</head>
<body>
    <div id="dashboard-container">
        <h1>Welcome to Your Dashboard</h1>
        <p>Manage your tutoring visibility below:</p>

        <!-- Subject Selection -->
        <label for="subject">Select a Subject:</label>
        <select id="subject">
            <option value="">--Select a Subject--</option>
            <option value="Math">Math</option>
            <option value="Biology">Biology</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Physics">Physics</option>
            <option value="Computer Science">Computer Science</option>
            <option value="English">English</option>
            <option value="Social Studies">Social Studies</option>
        </select>

        <!-- Subcategory Selection -->
        <div id="subcategory-container"></div>

        <div class="nav-buttons">
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <script type="module">
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Initialize Firestore
        const db = getFirestore();

        // Subject-to-Class Level Map
        const CLASS_LEVELS = {
            "Math": ["Algebra 1", "Geometry", "Algebra 2", "Precalculus", "Calculus AB", "Calculus BC", "Calculus 3"],
            "English": ["English 9", "English 10", "English 11", "English 12", "Speech"],
            "Social Studies": ["World History", "AP World History", "US History", "AP US History", "European History", "AP Microeconomics", "AP Macroeconomics"],
            "Physics": ["Physics 1", "Physics 2", "Physics C"],
            "Chemistry": ["Honors Chemistry", "AP Chemistry"],
            "Computer Science": ["CS Principles", "CS 1", "CS A"],
            "Biology": ["Honors Biology", "AP Biology"]
        };

        // Function: Modify Visibility Based on Subject Selection
        async function modifyVisibility() {
            const subject = document.getElementById("subject").value;
            const subcategoryContainer = document.getElementById("subcategory-container");
            const email = localStorage.getItem("loggedInTutor");

            subcategoryContainer.innerHTML = ""; // Clear previous selections

            if (!subject || !email) {
                subcategoryContainer.innerHTML = "<p>⚠️ Please select a subject.</p>";
                return;
            }

            try {
                const tutorRef = doc(db, "tutors", email);
                const tutorSnap = await getDoc(tutorRef);

                if (!tutorSnap.exists()) {
                    throw new Error("⚠️ Tutor account not found!");
                }

                const tutor = tutorSnap.data();
                const competency = tutor.competency[subject] || [];

                // Create checkboxes based on competency array
                const classList = CLASS_LEVELS[subject];
                if (!classList) {
                    subcategoryContainer.innerHTML = "<p>⚠️ No subcategories found for this subject.</p>";
                    return;
                }

                classList.forEach((className, index) => {
                    const isChecked = competency[index] || false; // Default to false if not found

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.id = `class-${index}`;
                    checkbox.checked = isChecked;
                    checkbox.dataset.index = index;

                    const label = document.createElement("label");
                    label.htmlFor = `class-${index}`;
                    label.textContent = className;

                    const div = document.createElement("div");
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    subcategoryContainer.appendChild(div);
                });

                // Add Save Changes Button
                const saveButton = document.createElement("button");
                saveButton.textContent = "Save Changes";
                saveButton.onclick = () => saveVisibility(subject);
                subcategoryContainer.appendChild(saveButton);

            } catch (error) {
                subcategoryContainer.innerHTML = `<p>❌ Error: ${error.message}</p>`;
            }
        }

        // Function: Save Updated Visibility
        async function saveVisibility(subject) {
            const email = localStorage.getItem("loggedInTutor");
            if (!email) {
                alert("⚠️ You must be logged in!");
                return;
            }

            const tutorRef = doc(db, "tutors", email);
            const tutorSnap = await getDoc(tutorRef);
            if (!tutorSnap.exists()) {
                alert("⚠️ Tutor account not found!");
                return;
            }

            const newVisibility = [];
            const checkboxes = document.querySelectorAll("#subcategory-container input[type='checkbox']");

            checkboxes.forEach((checkbox) => {
                const index = parseInt(checkbox.dataset.index);
                newVisibility[index] = checkbox.checked;
            });

            try {
                await updateDoc(tutorRef, { [`competency.${subject}`]: newVisibility });
                alert("✅ Visibility updated successfully!");
            } catch (error) {
                alert(`❌ Error updating visibility: ${error.message}`);
            }
        }

        // Attach Event Listener to Subject Dropdown
        document.getElementById("subject")?.addEventListener("change", modifyVisibility);

        // Logout Function
        function logout() {
            localStorage.removeItem("loggedInTutor");
            window.location.href = "manage_account.html";
        }
    </script>
</body>
</html>
